<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的即時資產儀表板</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <style> 
        body { background-color: #f8fafc; } 
        /* 讓圖表文字更清晰 */
        .recharts-text { font-family: sans-serif; font-weight: 500; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ============================================================================
        // ★★★ 請在下方雙引號中，貼上您的 Google 試算表 CSV 網址 ★★★
        // ============================================================================
        
        const MY_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRghdwdi-KiihvjPC5dGU_O8FRfzhZLp77JvD_dr1pRHtP_o39CEtFgk71oQwAGzLw5-ZNzB945UCLg/pub?output=csv"; 

        // ↑↑↑ 請貼在上面這兩個引號中間
        // ============================================================================


        const { useState, useEffect, useMemo } = React;
        // 加入 LabelList 用於長條圖顯示文字
        const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LabelList } = window.Recharts || {};

        // --- 圖示元件 ---
        const IconWallet = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-8 h-8 text-blue-600"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"/></svg>;
        const IconRefresh = ({ spinning }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`w-4 h-4 ${spinning ? 'animate-spin' : ''}`}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>;
        const IconTrending = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
        const IconPie = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
        const IconClock = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-3 h-3"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-3 h-3"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const IconLink = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>;

        const STORAGE_KEY = 'my-asset-dashboard-v4'; // 升級版本號
        
        const INITIAL_ASSETS = [
            { id: '00692', name: '富邦公司治理', type: 'TW', currency: 'TWD', shares: 5000, price: 63.05 },
            { id: 'IBIT', name: '比特幣 ETF', type: 'US', currency: 'USD', shares: 100, price: 54.24 },
            { id: 'TSLA', name: '特斯拉', type: 'US', currency: 'USD', shares: 20, price: 437.52 },
            { id: 'SMH', name: '半導體 ETF', type: 'US', currency: 'USD', shares: 15, price: 400.39 },
            { id: 'QQQM', name: '納斯達克 100 ETF', type: 'US', currency: 'USD', shares: 30, price: 255.71 }
        ];

        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#ff6b6b'];

        const AssetDashboard = () => {
            const [assets, setAssets] = useState(INITIAL_ASSETS);
            const [exchangeRate, setExchangeRate] = useState(31.65);
            const [loading, setLoading] = useState(false);
            const [lastUpdated, setLastUpdated] = useState("尚未同步");
            
            const [sheetUrl, setSheetUrl] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        return parsed.sheetUrl || '';
                    } catch (e) { return ''; }
                }
                return '';
            });
            const [showSettings, setShowSettings] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.assets) setAssets(parsed.assets);
                        if (parsed.exchangeRate) setExchangeRate(parsed.exchangeRate);
                        if (parsed.lastUpdated) setLastUpdated(parsed.lastUpdated);
                        if (parsed.sheetUrl) setSheetUrl(parsed.sheetUrl);
                    } catch (e) { console.error(e); }
                }
            }, []);

            useEffect(() => {
                const targetUrl = MY_SHEET_URL || sheetUrl;
                let finalUrl = targetUrl;
                if (targetUrl && targetUrl.includes('/edit')) {
                    finalUrl = targetUrl.replace(/\/edit.*$/, '/pub?output=csv');
                }

                if (finalUrl && finalUrl.includes('google.com')) {
                    fetchFromSheet(finalUrl, true);
                }
            }, [sheetUrl]); 

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    assets, exchangeRate, lastUpdated, sheetUrl
                }));
            }, [assets, exchangeRate, lastUpdated, sheetUrl]);

            const fetchFromSheet = async (urlOverride = null, isSilent = false) => {
                let targetUrl = urlOverride || MY_SHEET_URL || sheetUrl;

                // 本機檔案開啟警告
                if (window.location.protocol === 'file:' && !isSilent) {
                    alert('⚠️ 警告：請將檔案上傳至 GitHub Pages 以啟用連線功能。直接開啟檔案無法讀取 Google 試算表。');
                    return;
                }

                if (targetUrl && targetUrl.includes('/edit')) {
                    targetUrl = targetUrl.replace(/\/edit.*$/, '/pub?output=csv');
                }

                if (!targetUrl || !targetUrl.includes('google.com')) {
                    if (!isSilent) {
                        alert('請先設定 Google 試算表連結！');
                        setShowSettings(true);
                    }
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch(targetUrl);
                    if (!response.ok) throw new Error(`Status: ${response.status}`);
                    const text = await response.text();
                    
                    if (text.trim().startsWith('<!DOCTYPE html>') || text.includes('<html')) {
                        throw new Error('讀取到 HTML，請確認試算表已「發布到網路」為 CSV 格式。');
                    }

                    const rows = text.split('\n').map(row => row.split(','));
                    const priceMap = {};
                    
                    rows.forEach(row => {
                        if (row.length >= 2) {
                            const id = row[0].replace(/["\r]/g, '').trim().toUpperCase();
                            const price = parseFloat(row[1].replace(/["\r]/g, ''));
                            if (id && !isNaN(price)) {
                                priceMap[id] = price;
                            }
                        }
                    });

                    if (priceMap['USD']) setExchangeRate(priceMap['USD']);

                    let updatedCount = 0;
                    setAssets(currentAssets => {
                        return currentAssets.map(asset => {
                             const targetPrice = priceMap[asset.id] || priceMap[asset.id.toUpperCase()];
                             if (targetPrice) updatedCount++;
                             return targetPrice ? { ...asset, price: targetPrice } : asset;
                        });
                    });

                    setLastUpdated(new Date().toLocaleString());
                    if (!isSilent) alert(`更新成功！`);

                } catch (error) {
                    console.error(error);
                    if (!isSilent) alert(`更新失敗：${error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const calculateValueTWD = (asset) => {
                const rawValue = asset.shares * asset.price;
                return asset.currency === 'USD' ? rawValue * exchangeRate : rawValue;
            };

            const totalAssetsValue = useMemo(() => assets.reduce((acc, asset) => acc + calculateValueTWD(asset), 0), [assets, exchangeRate]);
            
            // 優化: 計算長條圖用的數據，加入百分比字串
            const barData = useMemo(() => assets.map(a => {
                const val = calculateValueTWD(a);
                const percent = totalAssetsValue > 0 ? (val / totalAssetsValue) * 100 : 0;
                return {
                    name: a.id,
                    台幣價值: Math.round(val),
                    原幣價格: a.price,
                    percentageStr: percent.toFixed(1) + '%' // 加入百分比字串
                };
            }), [assets, exchangeRate, totalAssetsValue]);

            // 圓餅圖數據
            const pieData = useMemo(() => assets.map(a => ({ 
                name: a.id, 
                value: calculateValueTWD(a) 
            })).sort((a, b) => b.value - a.value), [assets, exchangeRate]);

            const handleShareChange = (id, v) => setAssets(prev => prev.map(a => a.id === id ? { ...a, shares: Number(v) } : a));
            const handlePriceChange = (id, v) => setAssets(prev => prev.map(a => a.id === id ? { ...a, price: Number(v) } : a));
            
            const handleReset = () => {
                if (confirm('確定重置所有資料？')) {
                    localStorage.removeItem(STORAGE_KEY);
                    window.location.reload();
                }
            };

            if (!window.Recharts) return <div className="p-10 text-center">載入圖表庫中...</div>;

            return (
                <div className="min-h-screen font-sans p-4 md:p-8">
                    <div className="max-w-7xl mx-auto space-y-6">
                        
                        {/* 頂部控制區 */}
                        <div className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200 gap-4">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-2 text-slate-800">
                                    <IconWallet /> 我的資產儀表板
                                </h1>
                                <div className="flex items-center gap-2 mt-1 text-sm text-slate-500">
                                    <IconClock /> 最後更新: {lastUpdated}
                                </div>
                            </div>
                            
                            <div className="flex flex-wrap items-center gap-3">
                                <div className="bg-slate-100 px-3 py-2 rounded-lg text-sm font-medium text-slate-600">
                                    USD: {exchangeRate.toFixed(2)}
                                </div>
                                <button 
                                    onClick={() => fetchFromSheet(null, false)}
                                    className={`flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:scale-95 transition-all shadow-md hover:shadow-lg ${loading ? 'opacity-70' : ''}`}
                                    disabled={loading}
                                >
                                    <IconRefresh spinning={loading} />
                                    {loading ? '更新中...' : '立即同步股價'}
                                </button>
                                {!MY_SHEET_URL && (
                                    <button onClick={() => setShowSettings(!showSettings)} className="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-600">
                                        <IconSettings />
                                    </button>
                                )}
                            </div>
                        </div>

                        {!MY_SHEET_URL && (showSettings || !sheetUrl) && (
                            <div className="bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-xl text-sm">
                                <h3 className="font-bold flex items-center gap-2 mb-2"><IconLink /> 設定 Google 試算表</h3>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={sheetUrl}
                                        onChange={(e) => setSheetUrl(e.target.value)}
                                        placeholder="貼上您的 https://docs.google.com/.../pub?output=csv 網址"
                                        className="flex-1 p-2 border rounded text-sm font-mono"
                                    />
                                    <button onClick={() => fetchFromSheet(null, false)} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">儲存並測試</button>
                                </div>
                            </div>
                        )}

                        {/* 總資產顯示 */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-gradient-to-br from-blue-600 to-indigo-700 text-white p-6 rounded-2xl shadow-lg flex flex-col justify-center transform transition hover:scale-[1.02] duration-300">
                                <span className="text-blue-100 text-sm font-medium mb-1">總資產估值 (TWD)</span>
                                <div className="text-4xl font-bold tracking-tight">
                                    ${Math.round(totalAssetsValue).toLocaleString()}
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 md:col-span-2 h-64">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={barData} layout="vertical" margin={{left: 40, right: 60}}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} opacity={0.3} />
                                        <XAxis type="number" hide />
                                        <YAxis dataKey="name" type="category" width={60} tick={{fontSize: 12, fontWeight: 500}} />
                                        <Tooltip 
                                            cursor={{fill: '#f1f5f9'}}
                                            contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)'}}
                                            formatter={(value) => `$${value.toLocaleString()}`} 
                                        />
                                        {/* 長條圖顯示百分比文字 (使用 LabelList) */}
                                        <Bar dataKey="台幣價值" fill="#3b82f6" radius={[0, 4, 4, 0]} barSize={24}>
                                            <LabelList dataKey="percentageStr" position="right" style={{ fill: '#64748b', fontSize: '12px', fontWeight: 'bold' }} />
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* 持股明細與圖表 */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* 明細表 */}
                            <div className="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                        <IconSettings /> 持股明細
                                    </h3>
                                    <button onClick={handleReset} className="text-xs text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors">
                                        <IconTrash /> 重置
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead className="text-slate-500 text-xs uppercase bg-slate-50 border-b border-slate-100">
                                            <tr>
                                                <th className="p-4 font-semibold">代號</th>
                                                <th className="p-4 text-right font-semibold">股數</th>
                                                <th className="p-4 text-right font-semibold">現價</th>
                                                <th className="p-4 text-right font-semibold">總值 (TWD)</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {assets.map((asset) => (
                                                <tr key={asset.id} className="hover:bg-blue-50/50 transition-colors">
                                                    <td className="p-4">
                                                        <div className="font-bold text-slate-700">{asset.id}</div>
                                                        <div className="text-xs text-slate-400">{asset.name}</div>
                                                    </td>
                                                    <td className="p-4 text-right">
                                                        <input 
                                                            type="number" 
                                                            value={asset.shares} 
                                                            onChange={(e) => handleShareChange(asset.id, e.target.value)} 
                                                            className="w-24 text-right p-2 border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm" 
                                                        />
                                                    </td>
                                                    <td className="p-4 text-right">
                                                        <div className="flex flex-col items-end">
                                                            <input 
                                                                type="number" 
                                                                step="0.01" 
                                                                value={asset.price} 
                                                                onChange={(e) => handlePriceChange(asset.id, e.target.value)} 
                                                                className="w-24 text-right p-2 border border-slate-200 rounded-lg bg-slate-50 text-slate-600 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" 
                                                            />
                                                        </div>
                                                    </td>
                                                    <td className="p-4 text-right font-bold text-slate-700">
                                                        ${Math.round(calculateValueTWD(asset)).toLocaleString()}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* 圓餅圖 */}
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 min-h-[400px] flex flex-col">
                                <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><IconPie /> 資產占比</h3>
                                <div className="flex-grow">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie 
                                                data={pieData} 
                                                cx="50%" 
                                                cy="50%" 
                                                innerRadius={60} 
                                                outerRadius={100} 
                                                paddingAngle={4} 
                                                dataKey="value"
                                                stroke="none"
                                                // 圓餅圖顯示百分比標籤
                                                label={({ cx, cy, midAngle, innerRadius, outerRadius, percent }) => {
                                                    return `${(percent * 100).toFixed(1)}%`;
                                                }}
                                            >
                                                {pieData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                            </Pie>
                                            <Tooltip formatter={(value) => `$${value.toLocaleString()}`} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)'}} />
                                            <Legend verticalAlign="bottom" height={36} iconType="circle" />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AssetDashboard />);
    </script>
</body>
</html>